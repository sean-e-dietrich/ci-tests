version: 2
jobs:
  build:
    working_directory: /var/www/
    docker:
      - image: seandietrich/php:latest
        environment:
          - APACHE_DOCUMENTROOT: /var/www/docroot
      - image: mariadb:latest
        name: db
        environment:
          - MYSQL_ROOT_PASSWORD: root
          - MYSQL_DATABASE: drupal
          - MYSQL_USER: user
          - MYSQL_ROOT_PASSWORD: user
      - image: selenium/standalone-chrome
        name: browser
    steps:
      - run: rm -rf /var/www/*
      - run: echo " StrictHostKeyChecking no" >> /etc/ssh/ssh_config
      - run:
          command: |
            export DEBIAN_NONINTERACTVE=noninteractive
            apt update -y
            apt install -y xvfb
            # Configure and run the virtual display.
            export DISPLAY=:99
            sh -e /etc/init.d/xvfb start
            Xvfb :99 -ac -screen 0 1366x768x24 &>/dev/null &
            sleep 3

            # Download Chrome Driver.
            LATEST_CHROMEDRIVER=$(wget -q -O - http://chromedriver.storage.googleapis.com/LATEST_RELEASE)
            wget http://chromedriver.storage.googleapis.com/$LATEST_CHROMEDRIVER/chromedriver_linux64.zip
            unzip chromedriver_linux64.zip
            chmod +x chromedriver
            mkdir -p $HOME/.composer/vendor/bin
            mv -f chromedriver $HOME/.composer/vendor/bin/
            rm chromedriver_linux64.zip

            # Update Chrome.
            export CHROME_BIN=/usr/bin/google-chrome
            wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg -i google-chrome-stable_current_amd64.deb
            rm google-chrome-stable_current_amd64.deb
            google-chrome --version

            # Run selenium standalone server.
            SELENIUM="$HOME/.selenium/cache/selenium-server-standalone-2.53.1.jar";
            if [[ ! -f $SELENIUM ]]; then wget -O $SELENIUM http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.1.jar; fi
            java -jar $SELENIUM -port 4445 > /dev/null 2>&1 &
            echo "[  OK  ] Starting Selenium on the 4445 port ..."
      - checkout
